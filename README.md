# ChassisUp70(2025飞身上篮)

<img src="readme_img/robocon2025.jpg" alt="示例图片" width="300" height="180">
<img src="readme_img/Up70.jpg" alt="示例图片" width="180" height="180">

# 工程简介
本工程为2025年飞身上篮比赛的底盘主控代码。
内含对四/三个舵轮分控板的控制，舵轮底盘的解算，~~里程计的读取（已转移）~~等。

## 更新日志
在Ver 1.0版本之后，加入了`CHANGELOG.md`。如果需要版本变更记录，请查看 [CHANGELOG.md](CHANGELOG.md)。

## 代码使用说明
此部分为**使用**本代码的人提供说明。
适用版本号：`Ver 2.0`

## 车体控制
### 遥控器控制
本工程允许通过 **[**Huangney的遥控器**](https://www.bing.com "Huangney的遥控器")** 来控制底盘和车体，通过串口Uart2完成数据收发。

### API 控制
本工程允许通过 **预留的API接口** 来控制底盘，因此可以由上位机发出指令操控底盘前进。

#### 接口类型
上位机通过波特率为 **115200bps** 的 异步**串口**与底盘进行通信。

#### 数据包
串口通信需要按照预定好的数据包格式，向底盘发送消息。

不同数据包的长度为 不同的固定的 Byte。

数据包由 ***帧头、数据、校验、帧尾*** 组成，其中，帧头需要与帧尾保持一致，以防止错误。

``` c
uint8_t base_datapack = {0x01, data_0, data_1, ..., check_0, check_1, 0x01};
```
校验位0 —— 为数据位前半之和；校验位1 —— 为数据位后半之和。

由于其为uint8型，其只会保留最后一Byte。
``` c
uint8_t check_0 = (uint8_t)(data_0 + data_1 + ... + data_5);
uint8_t check_1 = (uint8_t)(data_6 + data_7 + ... + data_11);
```

#### 机器使能
机器人在上电时，处于锁定状态，此时只能通过 ***遥控器*** 控制，工控机无法控制，需要使能 **API控制模式** 才能进行控制。

帧头标识符号为 `0x01`。
```c
    {0x01, 0xfe, 0xfe, check_0, check_1, 0x01};
```

#### 请求 控制权接管 \ 控制权送回
API控制模式使能后，使用控制权命令来 `请求控制权` 或 `送回控制权`

`请求控制权`的帧头标识符号为 `0x02`。
```c
    {0x02, 0xfc, 0xfc, check_0, check_1, 0x02};
```

`送回控制权`的帧头标识符号为 `0x03`。
```c
    {0x03, 0xfc, 0xfc, check_0, check_1, 0x03};
```

#### 底盘移动
完全的底盘移动的帧头标识符号为 `0x10` ，此时默认帧长为 `10Byte`

此时，后续的帧格式为：
```c
    {0x10, 
    Vx_high, Vx_low, 
    Vy_high, Vy_low, 
    Vw_high, Vw_low, 
    check_0, check_1, 
    0x10};
```

此时的校验位 `check_0`, `check_1`为：
```c
uint8_t check_0 = (uint8_t)(Vx_high + Vx_low + Vy_high);
uint8_t check_1 = (uint8_t)(Vy_low + Vw_high + Vw_low);
```

#### 局部底盘移动
局部的底盘移动的帧头标识符号为 `0x11`、`0x12`、`0x13` ，分别对应`Vx`、`Vy`、`Vw`。

此覆写是**独立进行**的，也就是说，写入`Vx`不会使得`Vy`等其他参数归零。

此时默认帧长为 `6Byte` ,帧格式为：
```c
    {0x11, 
    Vx_high, Vx_low, 
    check_0, check_1, 
    0x11};

    {0x12, 
    Vy_high, Vy_low, 
    check_0, check_1, 
    0x12};

    {0x13, 
    Vw_high, Vw_low, 
    check_0, check_1, 
    0x13};
```

#### 紧急停止
帧头标识符号为 `0x04`，有两类急停类型。

第一类：**可恢复**急停
```c
    {0x04, 0x00, 0x00, check_0, check_1, 0x04};
```
急停之后，相当于进入未启动状态，可以使用启动指令重新启动。

第二类：**不可恢复**急停
```c
    {0x04, 0x00, 0x00, check_0, check_1, 0x04};
```
急停之后，除去重新上电，机器人将 ***完全自锁*** ，拒绝接收和发出任何指令。

#### 其他操作
等待后续开发

#### 反馈信息包
机器人在收到命令后会向串口上报自己的状态。

当你发送`0x00`到`0x0a`间的设置指令时，机器人会复读你的指令号

比如返回：
```c
    {0x01, 0x01};
```

#### 其他反馈包

`0x21`：机器人的定位信息，50Hz反馈

#### 视觉上位机通信数据格式

0XFA 三个四字节浮点数 0xFB

三个浮点分别表示 x线速度 y 线速度 z角速度 使用小端